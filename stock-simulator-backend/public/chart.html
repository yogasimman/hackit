<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Graph Generator</title>
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly JS for rendering the graph -->
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2>Line Graph Generator</h2>
        <form id="graphForm">
            <div class="mb-3">
                <label for="startDate" class="form-label">Start Date:</label>
                <input type="date" id="startDate<!DOCTYPE html>
                <html lang="en">
                <head>
                  <meta charset="UTF-8" />
                  <meta name="viewport" content="width=device-width, initial-scale=1" />
                  <title>InvestIQ - Market Simulator</title>
                  <!-- Bootstrap CSS -->
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
                  <!-- Bootstrap Icons -->
                  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
                  <!-- Google Fonts -->
                  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
                  <!-- Plotly JS -->
                  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
                  <!-- Custom CSS -->
                  <style>
                    body {
                      font-family: 'Montserrat', sans-serif;
                      background-color: #f5f7fa;
                      margin: 0;
                      padding: 0;
                    }
                    /* Top Navbar */
                    .navbar {
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      position: fixed;
                      width: 100%;
                      z-index: 1100;
                    }
                    .navbar .navbar-brand {
                      position: absolute;
                      left: 50%;
                      transform: translateX(-50%);
                    }
                    .navbar .navbar-right {
                      margin-left: auto;
                      display: flex;
                      align-items: center;
                    }
                    /* Sidebar */
                    .sidebar {
                      position: fixed;
                      top: 56px;
                      left: 0;
                      bottom: 0;
                      width: 80px;
                      background-color: #ffffff;
                      border-right: 1px solid #ddd;
                      padding-top: 20px;
                      z-index: 1050;
                      transition: width 0.3s;
                      overflow: hidden;
                    }
                    .sidebar:hover {
                      width: 200px;
                    }
                    .sidebar ul {
                      list-style: none;
                      padding: 0;
                    }
                    .sidebar .nav-link {
                      color: #555;
                      padding: 15px;
                      display: flex;
                      align-items: center;
                      white-space: nowrap;
                      transition: background-color 0.3s, color 0.3s;
                    }
                    .sidebar .nav-link i {
                      min-width: 30px;
                      font-size: 1.5rem;
                      text-align: center;
                    }
                    .sidebar .nav-link span {
                      opacity: 0;
                      margin-left: 10px;
                      transition: opacity 0.3s;
                    }
                    .sidebar:hover .nav-link span {
                      opacity: 1;
                    }
                    .sidebar .nav-link:hover {
                      background-color: #f0f0f0;
                      color: #000;
                    }
                    /* Main Content */
                    .main-content {
                      margin-left: 80px;
                      padding-top: 56px;
                      transition: margin-left 0.3s;
                    }
                    .sidebar:hover ~ .main-content {
                      margin-left: 200px;
                    }
                    .section-header {
                      margin: 20px 0;
                    }
                    .chart-container {
                      width: 100%;
                      margin-top: 20px;
                    }
                  </style>
                </head>
                <body>
                  <!-- Top Navbar -->
                  <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top">
                    <div class="container-fluid">
                      <a class="navbar-brand" href="#">InvestIQ</a>
                      <div class="navbar-right" id="navbar-right-content">
                        <a class="nav-link" href="login.html"><i class="bi bi-person-circle"></i> Login</a>
                      </div>
                    </div>
                  </nav>
                
                  <!-- Sidebar -->
                  <div class="sidebar bg-light">
                    <ul class="nav flex-column">
                      <li class="nav-item">
                        <a class="nav-link" href="index.html" title="Dashboard">
                          <i class="bi bi-speedometer2"></i><span>Dashboard</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                
                  <!-- Main Content -->
                  <div class="main-content container-fluid">
                    <!-- Investment Controls -->
                    <div class="row section-header">
                      <div class="col-md-4">
                        <label for="start-date" class="form-label">Start Date:</label>
                        <input type="date" id="start-date" class="form-control" required />
                      </div>
                      <div class="col-md-4">
                        <label for="investment" class="form-label">Initial Investment (INR):</label>
                        <input type="number" id="investment" class="form-control" step="0.01" min="0" required />
                      </div>
                      <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-success" id="load-chart-btn">Load Chart</button>
                      </div>
                    </div>
                
                    <!-- Line Graph Section -->
                    <div class="row section-header">
                      <div class="col-12">
                        <h4>Investment Simulation</h4>
                        <div id="chart-container" class="chart-container" style="height:600px;"></div>
                      </div>
                    </div>
                  </div>
                
                  <!-- Bootstrap JS Bundle -->
                  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                  <script>
                    document.getElementById('load-chart-btn').addEventListener('click', function() {
                      const startDate = document.getElementById('start-date').value;
                      const investment = document.getElementById('investment').value;
                
                      // Input validation
                      if (!startDate || !investment) {
                        alert('Please enter both a start date and an initial investment amount.');
                        return;
                      }
                      if (isNaN(investment) || investment <= 0) {
                        alert('Initial investment must be a positive number.');
                        return;
                      }
                
                      // Prepare request body
                      const requestBody = {
                        start_date: startDate,
                        initial_investment: parseFloat(investment)
                      };
                
                      // Fetch data from API
                      fetch('http://localhost:5000/api/simulate', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                      })
                      .then(response => {
                        if (!response.ok) {
                          throw new Error('Failed to fetch data from the API');
                        }
                        return response.json();
                      })
                      .then(data => {
                        const plotData = data.plot_data;
                        const dates = plotData.map(item => item.Date);
                        const stockNominal = plotData.map(item => item.StockValue_Nominal);
                        const cashNominal = plotData.map(item => item.Cash_Nominal);
                        const stockReal = plotData.map(item => item.StockValue_Real);
                        const cashReal = plotData.map(item => item.Cash_Real);
                
                        // Define chart data for Plotly
                        const chartData = [
                          {
                            x: dates,
                            y: stockNominal,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stock (Nominal)',
                            line: { color: 'blue' }
                          },
                          {
                            x: dates,
                            y: cashNominal,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Cash (Nominal)',
                            line: { color: 'red' }
                          },
                          {
                            x: dates,
                            y: stockReal,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stock (Real)',
                            line: { color: 'green' }
                          },
                          {
                            x: dates,
                            y: cashReal,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Cash (Real)',
                            line: { color: 'orange' }
                          }
                        ];
                
                        // Define chart layout
                        const layout = {
                          title: 'Investment Simulation Over Time',
                          xaxis: { title: 'Date' },
                          yaxis: { title: 'Value (INR)' },
                          legend: { x: 1, xanchor: 'right', y: 1 }
                        };
                
                        // Render the chart
                        Plotly.newPlot('chart-container', chartData, layout);
                      })
                      .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to load chart data. Please check your inputs and try again.');
                      });
                    });
                  </script>
                </body>
                </html>" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="endDate" class="form-label">End Date:</label>
                <input type="date" id="endDate" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Generate Graph</button>
        </form>
        <div id="graphContainer" class="mt-3" style="width:100%; height:600px;"></div>
        <div id="loading" class="mt-3" style="display:none;">Loading...</div>
        <div id="error" class="mt-3 text-danger" style="display:none;"></div>
    </div>

    <!-- JavaScript to handle form submission and graph rendering -->
    <script>
        document.getElementById('graphForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent page refresh

            // Get input values
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Validate inputs
            if (!startDate || !endDate) {
                alert('Please enter both start and end dates.');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date.');
                return;
            }

            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('graphContainer').innerHTML = '';

            // Prepare API request body
            const requestBody = {
                start_date: startDate,
                end_date: endDate
            };

            // Fetch data from API
            fetch('/api/get_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data from API');
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';

                // Validate received data
                if (!data || !data.dates || !data.values) {
                    throw new Error('Invalid data format received from API');
                }

                // Prepare Plotly chart data
                const chartData = [{
                    x: data.dates,
                    y: data.values,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'blue' }
                }];
                const layout = {
                    title: 'Data Trend Over Time',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Value' }
                };

                // Render the graph
                Plotly.newPlot('graphContainer', chartData, layout);
            })
            .catch(error => {
                // Show error message
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = 'Error: ' + error.message;
            });
        });
    </script>
</body>
</html>